# =========================
# Paths WITHOUT auth
# =========================

location = /api/products/health {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
}

location = /api/products/openapi.json {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service/openapi.json;
    proxy_set_header Host $host;
}

location = /api/products/docs {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service/docs;
    proxy_set_header Host $host;
}

location ~ ^/api/products/(redoc|openapi\.json) {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service$request_uri;
    proxy_set_header Host $host;
}

# =========================
# GET – lista pública
# =========================
location = /api/products {
    if ($request_method = OPTIONS) { return 204; }
    if ($request_method != GET) { return 405; }

    proxy_pass http://product_service/products$is_args$args;
    proxy_set_header Host $host;
}

# =========================
# GET – búsqueda pública
# =========================
location = /api/products/search {
    if ($request_method = OPTIONS) { return 204; }
    if ($request_method != GET) { return 405; }

    proxy_pass http://product_service/search$is_args$args;
    proxy_set_header Host $host;
}

# =========================
# POST – crear producto (AUTH)
# =========================
location = /api/products/ {
    if ($request_method = OPTIONS) { return 204; }
    if ($request_method != POST) { return 405; }

    auth_request /_validate_apikey;

    proxy_pass http://product_service/;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Web-Client-Token $http_x_web_client_token;
    proxy_set_header Host $host;
}

# =========================
# GET – producto por ID (PÚBLICO)
# =========================
location ~ ^/api/products/(\d+)$ {
    if ($request_method = OPTIONS) { return 204; }
    if ($request_method != GET) { return 405; }

    proxy_pass http://product_service/products/$1$is_args$args;
    proxy_set_header Host $host;
}

# =========================
# PUT / DELETE – producto por ID (AUTH)
# DEBE IR DESPUÉS DEL GET
# =========================
location ~ ^/api/products/(\d+)$ {
    if ($request_method = OPTIONS) { return 204; }
    if ($request_method !~ ^(PUT|DELETE)$) { return 405; }

    auth_request /_validate_apikey;

    proxy_pass http://product_service/products/$1$is_args$args;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Web-Client-Token $http_x_web_client_token;
    proxy_set_header Host $host;
}
