# =========================
# Paths WITHOUT auth
# =========================

location = /api/products/health {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service/health;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Content-Type $content_type;
    proxy_redirect off;
}

location = /api/products/openapi.json {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service/openapi.json;
    proxy_set_header Host $host;
}

location = /api/products/docs {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service/docs;
    proxy_set_header Host $host;
}

location ~ ^/api/products/(redoc|openapi\.json) {
    if ($request_method = OPTIONS) { return 204; }

    proxy_pass http://product_service$request_uri;
    proxy_set_header Host $host;
}

# =========================
# GET – lista pública
# =========================
location = /api/products {
    proxy_pass http://product_service/products$is_args$args;
    proxy_set_header Host $host;
}

# =========================
# GET – búsqueda pública
# =========================
location = /api/products/search {
    proxy_pass http://product_service/search$is_args$args;
    proxy_set_header Host $host;
}

# =========================
# POST – crear producto (AUTH)
# =========================
location /api/products/create {
    auth_request /_validate_apikey;

    proxy_pass http://product_service/;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Web-Client-Token $http_x_web_client_token;
}

# =========================
# PUT / DELETE por ID
# =========================
location ~ ^/api/products/(\d+)/(update|delete)$ {
    auth_request /_validate_apikey;

    proxy_pass http://product_service/$1/$2$is_args$args;
    proxy_set_header Host $host;
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Web-Client-Token $http_x_web_client_token;
}

# =========================
# GET público por ID
# =========================
location ~ ^/api/products/(\d+)$ {
    proxy_pass http://product_service/$1$is_args$args;
    proxy_set_header Host $host;
}